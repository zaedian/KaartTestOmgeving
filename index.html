<!DOCTYPE html>
<html>
<head>
    <title>Kaart testomgeving</title>
    <meta charset="utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/leaflet.css"/>
    <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
    
    <div id="map-container">
	<button id="mobile-toggle" class="mobile-toggle">☰</button>
        <div id="sidebar" class="open">
            <div class="sidebar-dark-area">
            <h2>Zoek jouw locatie</h2>
            <p>Een winkel vinden bij jou in de buurt?<br>Neem gerust een kijkje!</p>

                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Zoek op plaats of postcode" autocomplete="off">
                    <button id="searchButton"><img src="images/search-icon.svg" alt="Search"></button> 
                    <div id="autocomplete-suggestions"></div> </div>
            </div>

            <div class="sidebar-light-area">
                <div class="filter-controls">
                    <h3>Filter</h3>
                    <button id="clearFilters">Wis alle filters</button>
                </div>

                <div class="categories-section">
                    <h3>Categorieën</h3>
					<ul id="categoryList">
						<li>
							<label class="custom-checkbox">
								<input type="checkbox" value="vlees">
								<span class="checkmark"></span>
								Vlees verkoop
							</label>
						</li>
						<li>
							<label class="custom-checkbox">
								<input type="checkbox" value="zuivel kaas eieren">
								<span class="checkmark"></span>
								Zuivel / Kaas / Eieren verkoop
							</label>
						</li>

						<li>
							<label class="custom-checkbox">
								<input type="checkbox" value="groente fruit">
								<span class="checkmark"></span>
								Groente / Fruit verkoop
							</label>
						</li>
						<li>
							<label class="custom-checkbox">
								<input type="checkbox" value="brood">
								<span class="checkmark"></span>
								Brood verkoop
							</label>
						</li>
						<li>
							<label class="custom-checkbox">
								<input type="checkbox" value="bloemen">
								<span class="checkmark"></span>
								Bloemen verkoop
							</label>
						</li>
						<li>
							<label class="custom-checkbox">
								<input type="checkbox" value="zelfpluk">
								<span class="checkmark"></span>
								Zelfpluk / Pluktuin
							</label>
						</li>
						<li>
							<label class="custom-checkbox">
								<input type="checkbox" value="pakketten">
								<span class="checkmark"></span>
								Groentepakketten verkoop
							</label>
						</li>
					</ul>

                </div>

                <hr class="separator">

                <h3>Winkels</h3>
                <ul id="storeList">
                </ul>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="scripts/leaflet.js"></script>
    <script>
        const map = L.map('map', { attributionControl: false }).setView([51.9851, 5.8987], 9);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

		// Street and satellite options
		const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		});

		const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
		});

		const baseLayers = {
			"Kaart": streetMap,
			"Satelliet": satelliteMap
		};
		L.control.layers(baseLayers).addTo(map);
		streetMap.addTo(map);
		// End Street/satellite options

        const storeList = document.getElementById('storeList');
        const sidebar = document.getElementById('sidebar');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const clearFiltersButton = document.getElementById('clearFilters');
        const categoryList = document.getElementById('categoryList');
        const autocompleteSuggestions = document.getElementById('autocomplete-suggestions');

        let allShops = [];
        let markers = [];

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        function displayShops(shopsToDisplay) {
            clearMarkers();
            storeList.innerHTML = '';

            shopsToDisplay.forEach(winkel => {
                if (winkel.latitude && winkel.longitude) {
                    const latlng = [winkel.latitude, winkel.longitude];
                    const marker = L.marker(latlng).addTo(map);
                    markers.push(marker);

					marker.bindPopup(`
						<strong>${winkel.naam}</strong><span class="hide-on-mobile"><br></span>
						${winkel.adres}, ${winkel.postcode} ${winkel.locatie}<br>
						${winkel.producten}<br>
						<a href="${winkel.url}" target="_blank">> Bekijk deze winkel</a><br class="hide-on-mobile"> <a href="https://www.google.com/maps/place/${winkel.latitude},${winkel.longitude}" target="_blank">> Plan je route</a>
						<!-- <a href="https://www.google.com/maps/dir/?api=1&destination=${winkel.latitude},${winkel.longitude}" target="_blank">> Plan je route</a> -->
					`);
 
					marker.on('popupopen', () => {
						map.flyTo(latlng, 15, { duration: 3 });

						// Close the sidebar if on a mobile device
						if (isMobile()) {
							sidebar.classList.remove('open');
							// Invalidate map size after closing sidebar to ensure it renders correctly
							map.invalidateSize();
						}
					});

                    const li = document.createElement('li');
                    li.textContent = winkel.naam;
                    li.title = winkel.adres;

                    li.addEventListener('click', () => {
                        map.flyTo(latlng, 15, { duration: 3 });
                        marker.openPopup();
                    });

                    storeList.appendChild(li);
                }
            });
        }

		function applyFilters() {
			const searchTerm = searchInput.value.toLowerCase().trim();

			// Gather selected categories, and split any multi-value checkboxes
			const selectedCategories = Array.from(document.querySelectorAll('#categoryList input[type="checkbox"]:checked'))
				.flatMap(checkbox => checkbox.value.toLowerCase().split(/\s+/));

			let filteredShops = allShops.filter(winkel => {
				const matchesSearch = searchTerm === '' ||
					winkel.naam.toLowerCase().includes(searchTerm) ||
					winkel.adres.toLowerCase().includes(searchTerm) ||
					winkel.locatie.toLowerCase().includes(searchTerm) ||
					winkel.postcode.toLowerCase().includes(searchTerm);

				const matchesCategory = selectedCategories.length === 0 || (() => {
					if (!winkel.producten) return false;

					const productTags = winkel.producten
						.toLowerCase()
						.split(/[,|\/]/) // supports "kaas, zuivel", "kaas/zuivel"
						.map(s => s.trim());

					return selectedCategories.some(cat => productTags.includes(cat));
				})();

				return matchesSearch && matchesCategory;
			});

			displayShops(filteredShops);
		}



        // AUTOCOMPLETE FUNCTIONS
		
		//Not working yet.
		//searchInput.addEventListener('input', generateSuggestions);
		
        function generateSuggestions() {
            const query = searchInput.value.toLowerCase().trim();
            autocompleteSuggestions.innerHTML = '';
            autocompleteSuggestions.style.display = 'none';

            if (query.length < 2) return;

            const uniqueSuggestions = new Map();

            allShops.forEach(winkel => {
                const searchableFields = [winkel.locatie, winkel.postcode, winkel.adres, winkel.naam];

                for (const field of searchableFields) {
                    if (field && field.toLowerCase().includes(query)) {
                        let suggestionText = field;
                        let latlng = [winkel.latitude, winkel.longitude];

                        if (!uniqueSuggestions.has(suggestionText)) {
                            uniqueSuggestions.set(suggestionText, latlng);
                        }
                    }
                }
            });

            if (uniqueSuggestions.size > 0) {
                uniqueSuggestions.forEach((latlng, suggestionText) => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.classList.add('autocomplete-item');
                    suggestionItem.innerHTML = `<span class="location-icon"></span> ${suggestionText}`;
                    suggestionItem.dataset.lat = latlng[0];
                    suggestionItem.dataset.lng = latlng[1];
                    suggestionItem.dataset.suggestionText = suggestionText;

                    suggestionItem.addEventListener('click', (event) => {
                        const targetItem = event.currentTarget;
                        const lat = parseFloat(targetItem.dataset.lat);
                        const lng = parseFloat(targetItem.dataset.lng);
                        const text = targetItem.dataset.suggestionText;

                        searchInput.value = text;
                        map.flyTo([lat, lng], 14, { duration: 1.5 });
                        
                        autocompleteSuggestions.style.display = 'none';
                        applyFilters();
                    });
                    autocompleteSuggestions.appendChild(suggestionItem);
                });
                autocompleteSuggestions.style.display = 'block';
            }
        }

        document.addEventListener('click', (event) => {
            if (!searchInput.contains(event.target) && !autocompleteSuggestions.contains(event.target)) {
                autocompleteSuggestions.style.display = 'none';
            }
        });

        async function geocodeSearch(query) {
            if (!query) return;

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    const place = data[0];
                    const lat = parseFloat(place.lat);
                    const lon = parseFloat(place.lon);

                    map.flyTo([lat, lon], 14, { duration: 1.5 });

                    const tempMarker = L.marker([lat, lon]).addTo(map);
                    tempMarker.bindPopup(`<strong>${place.display_name}</strong>`).openPopup();

                    setTimeout(() => {
                        map.removeLayer(tempMarker);
                    }, 5000);

                    autocompleteSuggestions.style.display = 'none';
                    applyFilters();
                } else {
                    alert('Locatie niet gevonden, probeer het opnieuw.');
                }
            } catch (error) {
                console.error('Geocode fout:', error);
            }
        }

        searchButton.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (query.length === 0) {
                applyFilters();
            } else {
                geocodeSearch(query);
            }
        });

        searchInput.addEventListener('input', generateSuggestions);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                const query = searchInput.value.trim();
                if (query.length === 0) {
                    applyFilters();
                } else {
                    geocodeSearch(query);
                }
				
				//Close sidebar if mobile
				if (isMobile()) {
					sidebar.classList.remove('open'); // Close the sidebar
					map.invalidateSize(); // Invalidate map size
				}
            }
        });

		document.querySelectorAll('#categoryList li').forEach(li => {
			li.addEventListener('click', (event) => {
				// If the click was on the checkbox or label or inside it, ignore here
				if (event.target.tagName.toLowerCase() === 'input' || event.target.tagName.toLowerCase() === 'label') return;

				// Toggle the checkbox inside this li
				const checkbox = li.querySelector('input[type="checkbox"]');
				checkbox.checked = !checkbox.checked;

				// Trigger filter update
				applyFilters();
			});
		});

		// Also listen for direct checkbox change to apply filters
		document.querySelectorAll('#categoryList input[type="checkbox"]').forEach(checkbox => {
			checkbox.addEventListener('change', applyFilters);
		});


        clearFiltersButton.addEventListener('click', () => {
            searchInput.value = '';
            document.querySelectorAll('#categoryList input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            autocompleteSuggestions.style.display = 'none';
            map.flyTo([51.9851, 5.8987], 9, { duration: 1.5 });
            applyFilters();
        });

        map.on('popupclose', () => {
            map.flyTo([51.9851, 5.8987], 9, { duration: 1.5 });
			
			//  Open the sidebar if on a mobile device when the popup closes
			if (isMobile()) {
				sidebar.scrollTop = 0;
				sidebar.classList.add('open'); // Add the 'open' class to show the sidebar
				map.invalidateSize(); // Crucial for Leaflet to redraw itself after sidebar opens
			}
        });

		// Data fetch for sql database
        /*fetch('scripts/get-shops.php')
            .then(response => response.json())
            .then(data => {
                allShops = data; // Store all fetched shops
                displayShops(allShops); // Display all shops initially
            })
            .catch(error => {
                console.error('Fout bij het laden van winkeldatabase:', error);
            });*/


		// Data fetch for local json
        fetch('winkels.json')
            .then(response => response.json())
            .then(data => {
                allShops = data;
                displayShops(allShops);
            })
            .catch(error => {
                console.error('Fout bij het laden van winkels.json:', error);
            });


			// Mobile Toggle
			document.addEventListener('DOMContentLoaded', function () {
				const toggleButton = document.querySelector('.mobile-toggle');
				const sidebar = document.getElementById('sidebar');

				if (toggleButton && sidebar) {
					toggleButton.addEventListener('click', function () {
						sidebar.classList.toggle('open');
						// Don't call invalidateSize here directly anymore
					});

					// Listen for the sidebar's CSS transition to end (width or max-width)
					sidebar.addEventListener('transitionend', function (event) {
						if (event.propertyName === 'width' || event.propertyName === 'max-width') {
							map.invalidateSize();
						}
					});
				}
			});
			
			
			//Check if mobile
			function isMobile() {
				return window.innerWidth <= 768; // Based on your CSS media query breakpoint
			}


    </script>
</body>
</html>
